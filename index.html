<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema OS Profissional</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #e9ecef; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;}
        
        /* SELETOR DE MODO */
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
        .mode-btn { flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; text-align: center; font-weight: bold; color: #555; background: #f8f9fa; transition: all 0.2s; }
        .mode-btn.active { border-color: #007bff; color: #007bff; background: #e7f1ff; }
        .mode-btn:hover { background: #eee; }

        /* Formul√°rio */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        label { font-weight: bold; font-size: 0.9em; color: #555; display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* Bot√£o Salvar Principal */
        #btn-salvar { width: 100%; padding: 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 15px; font-weight: bold; background: #007bff; color: white; transition: background 0.3s;}
        #btn-salvar:hover { background: #0056b3; }
        #btn-cancelar-edicao { width: 100%; padding: 10px; background: #6c757d; color: white; border:none; border-radius:5px; margin-top: 10px; display: none; cursor: pointer;}

        /* Cards do Hist√≥rico */
        .card { background: #fff; border-left: 5px solid #ddd; margin-top: 15px; padding: 15px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* CORRE√á√ÉO DO LAYOUT MOBILE: Bot√µes embaixo */
        .card-actions { display: flex; gap: 10px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; justify-content: flex-end; }
        .btn-mini { padding: 8px 15px; font-size: 14px; border-radius: 4px; cursor: pointer; color: white; border: none; }
        .btn-editar { background: #f39c12; }
        .btn-excluir { background: #ff4757; }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em; color: #444; }
        
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; }

        /* Cores Status */
        .status-pendente { border-left-color: #ffc107; } .tag-pendente { background: #fff3cd; color: #856404; }
        .status-manutencao { border-left-color: #17a2b8; } .tag-manutencao { background: #d1ecf1; color: #0c5460; }
        .status-pronto { border-left-color: #28a745; } .tag-pronto { background: #d4edda; color: #155724; }
        .status-entregue { border-left-color: #6c757d; opacity: 0.8; } .tag-entregue { background: #e2e3e5; color: #383d41; }

        /* Checkbox */
        .check-box-container { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 5px; display: flex; align-items: center; cursor: pointer; }
        .check-box-container input { width: auto; margin-right: 10px; transform: scale(1.5); }
        
        /* Esconder/Mostrar se√ß√µes */
        .secao-oculta { display: none; }
        
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
    </style>
</head>
<body>

<div class="container">
    <h2 id="titulo-form">Nova Ordem de Servi√ßo</h2>
    
    <div class="mode-selector">
        <div class="mode-btn active" onclick="setMode('entrada')" id="btn-mode-entrada">üì• Entrada</div>
        <div class="mode-btn" onclick="setMode('manutencao')" id="btn-mode-manutencao">üîß Manuten√ß√£o</div>
        <div class="mode-btn" onclick="setMode('entrega')" id="btn-mode-entrega">üì¶ Entrega</div>
    </div>

    <form id="form-os">
        <input type="hidden" name="acao" id="acao" value="salvar">
        <input type="hidden" name="id_editar" id="id_editar">
        <input type="hidden" name="Data_Entrada" id="hidden_data_entrada">
        
        <div class="form-grid">
            <div class="full-width">
                <label>N¬∫ OS: <input type="text" id="display_id" value="Autom√°tico" disabled style="display:inline; width:100px; background:#f0f0f0; border:none;"></label>
            </div>

            <div id="grupo-entrada" class="full-width form-grid" style="grid-column: span 2; margin:0; padding:0;">
                <div class="full-width">
                    <label>Nome do Cliente *</label>
                    <input type="text" name="Cliente" id="cliente" placeholder="Nome completo">
                </div>
                <div>
                    <label>Telefone/WhatsApp *</label>
                    <input type="tel" name="Telefone" id="telefone" placeholder="DDD + N√∫mero">
                </div>
                 <div>
                    <label>Vendedor (Recebimento) *</label>
                    <input type="text" name="Vendedor" id="vendedor" placeholder="Quem recebeu?">
                </div>
                <div>
                    <label>Equipamento *</label>
                    <input type="text" name="Equipamento" id="equipamento" placeholder="Ex: Bomba Sapinho">
                </div>
                <div>
                    <label>Voltagem *</label>
                    <select name="Voltagem" id="voltagem">
                        <option value="N/D">N/D (N√£o Identificado)</option>
                        <option value="110v">110v</option>
                        <option value="127v">127v</option>
                        <option value="220v">220v</option>
                        <option value="254v">254v</option>
                    </select>
                </div>
                <div class="full-width">
                    <label>Acess√≥rios</label>
                    <input type="text" name="Acessorios" id="acessorios" placeholder="O que veio junto?">
                </div>
                <div class="full-width">
                    <label>Defeito Relatado *</label>
                    <input type="text" name="Defeito" id="defeito" placeholder="Reclama√ß√£o do cliente">
                </div>
            </div>

            <div id="grupo-manutencao" class="secao-oculta full-width form-grid" style="grid-column: span 2; background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #ddd;">
                <div class="full-width">
                    <h3 style="margin-top:0; color:#007bff;">√Årea do T√©cnico</h3>
                </div>
                <div class="full-width">
                    <label>T√©cnico Respons√°vel *</label>
                    <input type="text" name="Tecnico" id="tecnico" placeholder="Nome do T√©cnico">
                </div>
                <div class="full-width">
                    <label>Diagn√≥stico T√©cnico</label>
                    <textarea name="Diagnostico" id="diagnostico" placeholder="O que foi constatado?"></textarea>
                </div>
                
                <div class="full-width">
                    <label class="check-box-container">
                        <input type="checkbox" id="check_troca_caneca">
                        <span>‚ö†Ô∏è Houve troca de Caneca?</span>
                    </label>
                </div>
                <div class="full-width" id="box-serial" style="display:none; background:#fff3cd; padding:10px; border-radius:5px; border:1px solid #ffeeba;">
                    <label style="color:#d35400;">üî¢ Serial Caneca (Obrigat√≥rio)</label>
                    <input type="text" name="Serial_Caneca" id="serial_caneca">
                </div>
                
                <div class="full-width">
                    <label>Pe√ßas Trocadas / Servi√ßo</label>
                    <textarea name="Pecas_Trocadas" id="pecas_trocadas" placeholder="O que foi feito?"></textarea>
                </div>
            </div>
            
            <div class="full-width">
                <label>Status da OS</label>
                <select name="Status" id="status_campo">
                    </select>
            </div>

            <div id="grupo-entrega" class="secao-oculta full-width">
                 <label>Data de Sa√≠da / Entrega</label>
                 <input type="date" name="Data_Saida" id="data_saida">
            </div>

        </div>

        <button type="submit" id="btn-salvar">üíæ Salvar Entrada</button>
        <button type="button" id="btn-cancelar-edicao" onclick="cancelarEdicao()">Cancelar Edi√ß√£o / Novo</button>
    </form>
</div>

<div class="container" style="margin-top: 20px;">
    <h2>Consultar OS</h2>
    <input type="text" id="campo_busca" style="width:100%; padding:15px; border:2px solid #007bff; border-radius:30px; margin-bottom:15px;" placeholder="üîç Buscar Nome, ID, Status..." onkeyup="filtrarLista()">
    <div id="lista-os">Carregando...</div>
</div>

<script>
    // üî¥ COLE SEU LINK NOVO AQUI üî¥
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxyoZcOqdg6j6U5NKdKPwUZ7yAvUcLrEuUzoWGU-rwHSKQo4EZdtwy70Vor7CCYjVAgzg/exec'; 
    // ----------------------------

    // Configura√ß√£o inicial
    document.getElementById('hidden_data_entrada').value = new Date().toISOString().split('T')[0];
    let currentMode = 'entrada';

    // ELEMENTOS
    const form = document.forms['form-os'];
    const statusSelect = document.getElementById('status_campo');
    const checkCaneca = document.getElementById('check_troca_caneca');
    const serialBox = document.getElementById('box-serial');
    const serialInput = document.getElementById('serial_caneca');
    
    // FUN√á√ÉO PARA TROCAR OS MODOS
    function setMode(mode) {
        currentMode = mode;
        
        // Atualiza bot√µes visuais
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-mode-' + mode).classList.add('active');

        // Refer√™ncias aos grupos
        const gEntrada = document.getElementById('grupo-entrada');
        const gManutencao = document.getElementById('grupo-manutencao');
        const gEntrega = document.getElementById('grupo-entrega');
        const btnSalvar = document.getElementById('btn-salvar');

        // L√≥gica de Exibi√ß√£o
        if (mode === 'entrada') {
            gEntrada.classList.remove('secao-oculta');
            gManutencao.classList.add('secao-oculta');
            gEntrega.classList.add('secao-oculta');
            btnSalvar.innerText = "üíæ Salvar Entrada";
            
            // Campos obrigat√≥rios Entrada
            document.getElementById('cliente').required = true;
            document.getElementById('vendedor').required = true;
            document.getElementById('tecnico').required = false;

            // Status fixo
            statusSelect.innerHTML = '<option value="Aguardando Avalia√ß√£o">Aguardando Avalia√ß√£o</option>';
        } 
        else if (mode === 'manutencao') {
            gEntrada.classList.add('secao-oculta'); // Esconde dados b√°sicos pra focar na t√©cnica (ou pode deixar visivel se preferir)
            gManutencao.classList.remove('secao-oculta');
            gEntrega.classList.add('secao-oculta');
            btnSalvar.innerText = "üîß Salvar Manuten√ß√£o";

            // Campos obrigat√≥rios Manuten√ß√£o
            document.getElementById('cliente').required = false; // J√° foi preenchido
            document.getElementById('vendedor').required = false;
            document.getElementById('tecnico').required = true;

            // Status Op√ß√µes
            statusSelect.innerHTML = `
                <option value="Em Manuten√ß√£o">Em Manuten√ß√£o</option>
                <option value="Aguardando Pe√ßa">Aguardando Pe√ßa</option>
                <option value="Pronto">Pronto</option>
            `;
        }
        else if (mode === 'entrega') {
            gEntrada.classList.add('secao-oculta');
            gManutencao.classList.add('secao-oculta');
            gEntrega.classList.remove('secao-oculta');
            btnSalvar.innerText = "üì¶ Finalizar Entrega";
            
            document.getElementById('tecnico').required = false;
            document.getElementById('data_saida').valueAsDate = new Date(); // Data hoje

            // Status Op√ß√µes
            statusSelect.innerHTML = `
                <option value="Entregue Consertada">Entregue Consertada</option>
                <option value="N√£o Arrumou">N√£o Arrumou (Devolvida)</option>
            `;
        }
    }

    // Inicializa no modo entrada
    setMode('entrada');

    // Valida√ß√£o Caneca
    function verificarCaneca() {
        if (checkCaneca.checked) {
            serialBox.style.display = 'block';
            if (statusSelect.value === 'Pronto') {
                serialInput.required = true;
                serialBox.style.border = "2px solid red";
            } else {
                serialInput.required = false;
                serialBox.style.border = "1px solid #ffeeba";
            }
        } else {
            serialBox.style.display = 'none';
            serialInput.required = false;
            serialInput.value = "";
        }
    }
    checkCaneca.addEventListener('change', verificarCaneca);
    statusSelect.addEventListener('change', verificarCaneca);

    // FUN√á√ÉO PREPARAR EDI√á√ÉO
    window.prepararEdicao = function(linhaStr) {
        // Converte string JSON de volta para objeto
        const linha = JSON.parse(decodeURIComponent(linhaStr));
        // Mapeamento: 0:ID, 1:Ent, 2:Sai, 3:Cli, 4:Tel, 5:Equip, 6:Volt, 7:Acess, 8:Def, 9:Vend, 10:Tec, 11:Diag, 12:Pecas, 13:Status, 14:Serial

        document.getElementById('titulo-form').innerText = "Editando OS #" + linha[0];
        document.getElementById('btn-cancelar-edicao').style.display = "block";
        
        // Preenche campos ocultos
        document.getElementById('acao').value = "editar";
        document.getElementById('id_editar').value = linha[0];
        document.getElementById('display_id').value = linha[0];
        
        // Preenche TODOS os campos (independente de estarem vis√≠veis)
        // Datas
        if(linha[1]) try { document.getElementById('hidden_data_entrada').value = new Date(linha[1]).toISOString().split('T')[0]; } catch(e){}
        if(linha[2]) try { document.getElementById('data_saida').value = new Date(linha[2]).toISOString().split('T')[0]; } catch(e){}

        document.getElementById('cliente').value = linha[3];
        document.getElementById('telefone').value = linha[4];
        document.getElementById('equipamento').value = linha[5];
        document.getElementById('voltagem').value = linha[6];
        document.getElementById('acessorios').value = linha[7];
        document.getElementById('defeito').value = linha[8];
        document.getElementById('vendedor').value = linha[9];
        document.getElementById('tecnico').value = linha[10];
        document.getElementById('diagnostico').value = linha[11];
        document.getElementById('pecas_trocadas').value = linha[12];
        
        // Serial
        if (linha[14] && linha[14] !== "") {
            checkCaneca.checked = true;
            serialInput.value = linha[14];
        } else {
            checkCaneca.checked = false;
        }

        // Define o modo baseado no status atual para facilitar
        if(linha[13] && linha[13].includes('Aguardando Avalia√ß√£o')) {
            setMode('manutencao'); // Se estava aguardando, o pr√≥ximo passo √© manuten√ß√£o
        } else if (linha[13] && linha[13].includes('Pronto')) {
            setMode('entrega'); // Se j√° est√° pronto, pr√≥ximo passo √© entrega
        } else {
            setMode('manutencao'); // Padr√£o edi√ß√£o
        }
        
        // For√ßa o valor do status ap√≥s mudar o modo (pois o modo reseta o select)
        // Pequeno delay para garantir que o select foi recriado
        setTimeout(() => {
             // Se o status atual n√£o existir nas op√ß√µes do modo, adiciona temporariamente
             let exists = Array.from(statusSelect.options).some(o => o.value === linha[13]);
             if(!exists) {
                 let opt = document.createElement('option');
                 opt.value = linha[13];
                 opt.innerText = linha[13];
                 opt.selected = true;
                 statusSelect.add(opt);
             } else {
                 statusSelect.value = linha[13];
             }
             verificarCaneca();
        }, 100);

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.cancelarEdicao = function() {
        form.reset();
        document.getElementById('titulo-form').innerText = "Nova Ordem de Servi√ßo";
        document.getElementById('btn-cancelar-edicao').style.display = "none";
        document.getElementById('acao').value = "salvar";
        document.getElementById('id_editar').value = "";
        document.getElementById('display_id').value = "Autom√°tico";
        document.getElementById('hidden_data_entrada').value = new Date().toISOString().split('T')[0];
        setMode('entrada');
    }

    // ENVIO DO FORMUL√ÅRIO
    form.addEventListener('submit', e => {
        e.preventDefault();
        
        // Valida√ß√£o extra do Serial
        if(checkCaneca.checked && statusSelect.value === 'Pronto' && serialInput.value.trim() === "") {
            alert("ERRO: Serial obrigat√≥rio para status Pronto!"); return;
        }

        const btn = document.getElementById('btn-salvar');
        const txtOriginal = btn.innerText;
        btn.innerText = "Processando...";
        btn.disabled = true;

        fetch(scriptURL, { method: 'POST', body: new FormData(form)})
            .then(response => response.json())
            .then(data => {
                if(data.result === 'success') {
                    alert("‚úÖ " + (data.message || "Salvo com sucesso!"));
                    cancelarEdicao(); // Limpa tudo
                    carregarOS();
                } else {
                    alert("Erro: " + data.message);
                }
                btn.innerText = txtOriginal;
                btn.disabled = false;
            })
            .catch(error => { 
                console.error('Erro!', error); 
                alert("Erro de conex√£o."); 
                btn.disabled = false; 
            })
    });

    // Excluir
    window.excluirOS = function(id) {
        let senha = prompt("Senha Mestra para excluir #" + id + ":");
        if (senha) {
            let formData = new FormData();
            formData.append('acao', 'excluir');
            formData.append('id_excluir', id);
            formData.append('senha', senha);
            fetch(scriptURL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => { alert(data.message); carregarOS(); })
        }
    }

    // Carregar Lista
    function carregarOS() {
        const lista = document.getElementById('lista-os');
        lista.innerHTML = "<p style='text-align:center'>Atualizando...</p>";
        fetch(scriptURL)
        .then(res => res.json())
        .then(data => {
            lista.innerHTML = "";
            data.forEach(linha => {
                // Encode para passar no bot√£o editar sem quebrar aspas
                let linhaStr = encodeURIComponent(JSON.stringify(linha));

                // Status Class
                let st = linha[13] || '';
                let classeStatus = 'status-pendente';
                let classeTag = 'tag-pendente';
                if(st.includes('Pronto')) { classeStatus = 'status-pronto'; classeTag = 'tag-pronto'; }
                if(st.includes('Entregue')) { classeStatus = 'status-entregue'; classeTag = 'tag-entregue'; }
                if(st.includes('Manuten√ß√£o')) { classeStatus = 'status-manutencao'; classeTag = 'tag-manutencao'; }

                let html = `
                <div class="card ${classeStatus}">
                    <div class="card-header">
                        <strong>#${linha[0]} - ${linha[3]}</strong>
                        <span class="status-badge ${classeTag}">${st}</span>
                    </div>
                    
                    <div class="card-details">
                        <div>üìÖ ${linha[1] ? new Date(linha[1]).toLocaleDateString('pt-BR') : '-'}</div>
                        <div>‚ö° ${linha[6]}</div>
                        <div style="grid-column: span 2">‚öôÔ∏è ${linha[5]}</div>
                        ${linha[10] ? `<div style="grid-column: span 2">üîß T√©c: ${linha[10]}</div>` : ''}
                    </div>

                    <div class="card-actions">
                         <a href="https://wa.me/55${linha[4]}?text=Ol√° ${linha[3]}, OS ${linha[0]}..." target="_blank" style="text-decoration:none; color:#28a745; font-weight:bold; margin-right:auto; align-self:center;">üì≤ WhatsApp</a>
                        <button class="btn-mini btn-editar" onclick="prepararEdicao('${linhaStr}')">‚úèÔ∏è Editar</button>
                        <button class="btn-mini btn-excluir" onclick="excluirOS('${linha[0]}')">üóëÔ∏è</button>
                    </div>
                </div>`;
                lista.innerHTML += html;
            });
        });
    }

    window.filtrarLista = function() {
        let termo = document.getElementById('campo_busca').value.toLowerCase();
        let cards = document.getElementsByClassName('card');
        for (let card of cards) card.style.display = card.innerText.toLowerCase().includes(termo) ? "" : "none";
    }

    carregarOS();
</script>

</body>
</html>
